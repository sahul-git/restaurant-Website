<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orders - Restaurant Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="nav-container"></div>

  <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Order Management</h1>
        <button onclick="openNewOrderModal()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
          + New Order
        </button>
      </div>

      <div class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Table</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="ordersTable"></tbody>
        </table>
        <div id="noOrders" class="hidden text-center py-12 text-gray-500">No orders found</div>
      </div>
    </div>
  </main>

  <!-- Order Modal -->
  <div id="orderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-4">New Order</h2>
      <form id="orderForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Table</label>
          <select id="orderTableId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <option value="">Select a table</option>
          </select>
        </div>

        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="block text-sm font-medium text-gray-700">Menu Items</label>
            <button type="button" onclick="addOrderItem()" class="text-sm text-blue-600 hover:text-blue-900">
              + Add Item
            </button>
          </div>
          <div id="orderItems"></div>
        </div>

        <div class="flex justify-end space-x-3">
          <button type="button" onclick="hideModal('orderModal')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
            Create Order
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/common.js"></script>
  <script>
    let orderItems = [{ menuItemId: '', quantity: 1 }];

    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAuth()) return;

      renderNav();

    function loadOrders() {
      const orders = storage.getOrders();
      const tables = storage.getTables();
      const tbody = document.getElementById('ordersTable');
      const noOrders = document.getElementById('noOrders');

      if (orders.length === 0) {
        tbody.innerHTML = '';
        noOrders.classList.remove('hidden');
        return;
      }

      noOrders.classList.add('hidden');
      tbody.innerHTML = orders.map(order => {
        const table = tables.find(t => t.id === order.tableId);
        return `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
              #${order.id.slice(0, 8)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              ${table ? `Table ${table.number}` : 'N/A'}
            </td>
            <td class="px-6 py-4 text-sm text-gray-900">
              ${order.items?.length || 0} items
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
              ${formatCurrency(order.total)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(order.status)}">
                ${order.status}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <select
                onchange="updateOrderStatus('${order.id}', this.value)"
                class="text-sm border border-gray-300 rounded px-2 py-1"
              >
                <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                <option value="served" ${order.status === 'served' ? 'selected' : ''}>Served</option>
                <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
              </select>
            </td>
          </tr>
        `;
      }).join('');
    }

      function openNewOrderModal() {
        orderItems = [{ menuItemId: '', quantity: 1 }];
        window.orderItems = orderItems;
        document.getElementById('orderForm').reset();
        renderOrderItems();
        
        const tableSelect = document.getElementById('orderTableId');
        const tables = storage.getTables();
        tableSelect.innerHTML = '<option value="">Select a table</option>' +
          tables.map(t => `<option value="${t.id}">Table ${t.number} - ${t.location}</option>`).join('');
        
        showModal('orderModal');
      }

      function addOrderItem() {
        orderItems.push({ menuItemId: '', quantity: 1 });
        window.orderItems = orderItems;
        renderOrderItems();
      }

      function removeOrderItem(index) {
        orderItems.splice(index, 1);
        window.orderItems = orderItems;
        renderOrderItems();
      }

      window.openNewOrderModal = openNewOrderModal;
      window.addOrderItem = addOrderItem;
      window.removeOrderItem = removeOrderItem;
      window.orderItems = orderItems;

      function renderOrderItems() {
        const menu = storage.getMenu();
        const container = document.getElementById('orderItems');
        container.innerHTML = orderItems.map((item, index) => {
          const selectId = `orderItemSelect_${index}`;
          const inputId = `orderItemQty_${index}`;
          return `
            <div class="flex space-x-2 mb-2">
              <select
                id="${selectId}"
                required
                onchange="window.orderItems[${index}].menuItemId = this.value"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-lg"
              >
                <option value="">Select item</option>
                ${menu.filter(m => m.available).map(menuItem => `
                  <option value="${menuItem.id}" ${item.menuItemId === menuItem.id ? 'selected' : ''}>
                    ${menuItem.name} - ${formatCurrency(menuItem.price)}
                  </option>
                `).join('')}
              </select>
              <input
                type="number"
                id="${inputId}"
                required
                min="1"
                value="${item.quantity}"
                onchange="window.orderItems[${index}].quantity = parseInt(this.value) || 1"
                class="w-20 px-3 py-2 border border-gray-300 rounded-lg"
                placeholder="Qty"
              />
              ${orderItems.length > 1 ? `
                <button
                  type="button"
                  onclick="removeOrderItem(${index})"
                  class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                >
                  Remove
                </button>
              ` : ''}
            </div>
          `;
        }).join('');
      }

      window.orderItems = orderItems;
      window.renderOrderItems = renderOrderItems;

      function updateOrderStatus(orderId, status) {
        try {
          storage.updateOrder(orderId, { status });
          loadOrders();
        } catch (error) {
          alert('Failed to update order: ' + error.message);
        }
      }

      window.updateOrderStatus = updateOrderStatus;

      document.getElementById('orderForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = {
          tableId: document.getElementById('orderTableId').value,
          items: orderItems.filter(item => item.menuItemId),
          status: 'pending',
        };

        if (formData.items.length === 0) {
          alert('Please add at least one menu item');
          return;
        }

        try {
          storage.createOrder(formData);
          hideModal('orderModal');
          loadOrders();
        } catch (error) {
          alert('Failed to create order: ' + error.message);
        }
      });

      loadOrders();
    });
  </script>
</body>
</html>
